#!/bin/sh
#
# glibretro: glib 1.2.x configuration system.
# configure script
# Copyright (c) Devin Smith 2009-2025
#

###############################################################################
# default parameters
PREFIX="/usr/local"
VERSION="1.2.10"
GLIB_MAJOR_VERSION=1
GLIB_MINOR_VERSION=2
GLIB_PATCH_LEVEL=10
SHARED_LIB_SUFFIX=".so"

###############################################################################
# Check for command line arguments
for arg in $*; do
optarg=`echo $arg | sed 's/[-a-z]*=//'`
case $arg in
    --prefix=*)
      PREFIX="$optarg"
      ;;
    *)
      echo "glibretro build configuration script"
      echo
      echo "Target directories:"
      echo " --prefix=PREFIX        path to install to"
      echo
      exit 1
      ;;
esac
done

printf "checking for valid C compiler... "

echo '#include <stdio.h>

int main(int argc, char *argv[])
{
	static int x = 0;
	static int y = 1;
	printf("%i,%i", x, y);
	return 0;
}
' > _testprog.c

if [ z"$CC" = z ]; then
  CC=cc
fi

if $CC $CFLAGS -c -o _testprog _testprog.c > /dev/null 2> /dev/null ; then
  : C compiler works ok
else
	# try gcc
	CC=gcc
	if $CC $CFLAGS -c -o _testprog _testprog.c > /dev/null 2> /dev/null ; then
		: C compiler works ok
	else
		echo "ERROR: \"$CC\" either does not exist or does not work"
		exit 1
	fi
fi
rm -f _testprog*

printf "$CC\n"

cf_os=`uname`
if test "$cf_os" = Darwin ; then
  cf_os=mac
else
  cf_os=n
fi

###############################################################################
# Build the config.mak file
echo "# Generated by $0 $*" > config.mak
echo >> config.mak
echo "PREFIX=${PREFIX}" >> config.mak
echo "VERSION=${VERSION}" >> config.mak
echo >> config.mak

####
# Create config.h
#  Head of config.h:
printf "/*
 *  THIS FILE IS AUTOMATICALLY CREATED BY configure!
 *  DON'T EDIT THIS FILE MANUALLY, IT WILL BE OVERWRITTEN.
 */
\n#ifndef GLIB_CONFIG_H\n#define GLIB_CONFIG_H\n\n" > include/config.h
printf "#define VERSION \"${VERSION}\"\n" >> include/config.h

fc_check_size() {
  printf "checking size of $1... "

  echo '#include <stdio.h>
  int main(void)
  {
    printf("%d", sizeof(long));
    return (0);
  }
  ' > _testprog.c
  $CC $CFLAGS _testprog.c -o _testprog 2> /dev/null
  X=`./_testprog`
  printf "$X\n"
  printf "#define $2 $X\n" >> include/config.h
  rm -f _testprog*
}

fc_check_header()
{
  printf "checking for $1... "

  echo "#include <$1>
  int main(void)
  {
    return (0);
  }
  " > _testprog.c
  if $CC $CFLAGS _testprog.c -o _testprog 2> /dev/null ; then
    printf "yes\n";
    printf "#define " >> include/config.h
    echo "HAVE_$1 1" | tr [a-z./] [A-Z__] >> include/config.h
  else
    printf "no\n";
  fi
  rm -f _testprog*
}

fc_check_size long SIZEOF_LONG
fc_check_size "void *" SIZEOF_VOID_P

fc_check_header unistd.h
fc_check_header sys/select.h

printf "#define GLIB_INTERFACE_AGE $GLIB_PATCH_LEVEL\n" >> include/config.h
printf "#define GLIB_BINARY_AGE $GLIB_PATCH_LEVEL\n" >> include/config.h

printf "\n#endif /* GLIB_CONFIG_H */" >> include/config.h
